package decrypt

import (
	"encoding/hex"
	"fmt"
	"log"
	"testing"
)

func ExampleCreateLocalKey() {
	salt, err := hex.DecodeString("b0ca901027e08bc58296fa67d2e2383f2e62ff5feecc38fb0939d2a9cc2d4561")
	if err != nil {
		log.Fatal(err)
	}
	settingsKey := CreateLocalKey([]byte{}, salt)
	fmt.Println(hex.EncodeToString(settingsKey[:]))
	// Output:
	// f0b32257268466df8e2c6eb865711350659e03a6765b2d388ec40fa7a267ba6c55e65c8b78f3986a6cf8ba94db76c3e8527af6e0de62d5112253d001909e4757e035a1d78548c71dcd6d400a8cbd0b7aad3ae814bf043f2c874011e66d5ba2c512f2590104df08b9a9f29a004324499a91d97778b0a8824a556ab66d0964085387a213bcbb114de85c0a49dc07a51baafaf8ca411b725f0cd083dda703506cfa9c85124f79db7b751a9c157223b829347bf279faccf8ca484e5ac9113cce223fd6bab4c10501ad859002dce92a7c5118da795d37f177180078815bc4718851b2255be5a44bf5049211d5fd2e085a1b01d45df9c3d0d06a7d3618b359e91fab71
}

func TestPrepareAESOldmtp(t *testing.T) {
	cases := []struct {
		globalKey string
		msgKey    string
		key       string
		iv        string
	}{
		{
			"172f55c5cfc4b6256bf183623aa25384f46c59256d0fbc772fdb5a1612f312d7878c57769c00ec8329781140e8e765c526e4ec460d8cc741b10dca90b56131e1b03dc0466b1453ebb9f5d8889e19919027fd06afa165088bd2636c1c7c3df9725b0b9b31c665b34d3351cca5dd626c1cdea216378566e815e53dfca661e6de892d67b833d191f21d",
			"961e4dfa328436a2245d7028ee919890",
			"b3225965bbb000023db5b25b18130cd1e331a2408d12e8c3af2b3f89a5588729",
			"07698990318f43a8ec049647a4332451105870ef00496cfa07e27741368d97ef",
		},
		{
			"f0b32257268466df8e2c6eb865711350659e03a6765b2d388ec40fa7a267ba6c55e65c8b78f3986a6cf8ba94db76c3e8527af6e0de62d5112253d001909e4757e035a1d78548c71dcd6d400a8cbd0b7aad3ae814bf043f2c874011e66d5ba2c512f2590104df08b9a9f29a004324499a91d97778b0a8824a556ab66d0964085387a213bcbb114de8",
			"965de3cb9a78821c6b112cd0548c4b6e",
			"0b6166bbca23cdb152f4207c8ed6744d162e358c1cd992c46e73efe599cf067a",
			"124436550c3ed988f1ee64ee36878f5516ea6b92f43e05c7af445e4d4e3af248",
		},
		{
			"f0b32257268466df8e2c6eb865711350659e03a6765b2d388ec40fa7a267ba6c55e65c8b78f3986a6cf8ba94db76c3e8527af6e0de62d5112253d001909e4757e035a1d78548c71dcd6d400a8cbd0b7aad3ae814bf043f2c874011e66d5ba2c512f2590104df08b9a9f29a004324499a91d97778b0a8824a556ab66d0964085387a213bcbb114de8",
			"94f85a1bc7a9a528a36404b57c89d193",
			"6947a41539482e54eb57550a31de5d388180f6bb49ad374ce9fe3abb2e2fba24",
			"00ff7d54192032f67324cb2a2e7dbab9984514cb1f3ea960bd67ac90aae87e69",
		},
	}
	for _, tt := range cases {
		_globalKey, err := hex.DecodeString(tt.globalKey)
		if err != nil {
			t.Fatal(err, tt.globalKey)
		}
		_msgKey, err := hex.DecodeString(tt.msgKey)
		if err != nil {
			t.Fatal(err, tt.msgKey)
		}
		_key, _iv := PrepareAESOldmtp(_globalKey, _msgKey)
		key := hex.EncodeToString(_key)
		iv := hex.EncodeToString(_iv)
		if tt.key != key {
			t.Errorf("key: expected %s, got %s", tt.key, key)
		}
		if tt.iv != iv {
			t.Errorf("iv: expected %s, got %s", tt.iv, iv)
		}
	}
}

func TestDecryptLocal(t *testing.T) {
	cases := []struct {
		salt      string
		encrypted string
		key       string
		decrypted string
	}{
		{
			"b0ca901027e08bc58296fa67d2e2383f2e62ff5feecc38fb0939d2a9cc2d4561",
			"4fb0453b3a675ab56d5e5e2088c5dad7c03ef053cd2e56d2afa5f6582f3ed8be97ccead39c64cc27167eb61f319b73a1b614a97f6f82742090065389cae892f94694c1e3527cdd8e64a2830641bedd4b8af2971a0cf93213182677d0d54dba58a96cbb6e0e279c6160d1d434f7146fd9e4bb8e3c75908b52243db395de506566957da30a2023499f500146975ecac7196a115e5703444d946bcdb5702c221225ef6c3d12f05569b9ed48eda0b4c734232a1420b9dd2d4c5538bc764635fdffe6c0565353a8a1c9abece4ac9dbbd653c3fc83e5359b0c960bc429acb191e03641c3c52502e1a6e2dcf5f4c645c165fe82df7c4f19bb7b3321bde735d6b3d12e307c632cd4c1025bcc53cde0105bf763ee2971d7f9046a788bec6a37d433d140f2c949141dcc2a47ba8dcb3d7a2ff73d3fb3bc3e126584a3287dca4f7c1418c4cf3d7fdabf86effb4ea59480f685ff9ff2c118270a996568065e798b1798418659b081398e40f9b93b2a0d53db12b93d80a4f0ad27ff00be213bdb45e92436abfd6b68761e1d6f5f1db6fa3b093616c5867ae90a27027f408c0a67c501f131a2b548e540bb0eae71558cda2e0c2bf4f79da3928dc52abf529aecc26f088d6c2dcc7b92f660bff54135dd8320c9edcdb2e5894fdce34b4b57c196cb4e68b2e5f957c90406a3e0e580c100a01d462759df684db5eddb04d033964b5aefbaeb7b8c7fa9ab57f321704cf9c927ead77c20a32f9662637ab92b4aee03ebf296fe06670370d90f09c0c0315d2159b9a4660855eef0539a658c02ec911af05a8b98a22bb892920df9096b72427b1031109ca6dac14cb03ed1906cc577793f384a2d58adff3fe73286f26647f79e0b728a320b8a7ffd5a3982f2926893cff7cfa873d2ab498c15435aa09aafbc785a49a4b262f9715dcc4a40946a76168878085a96c21667b801d64bfaa75789cb72901bed7babdbc81c280c90155656bb5a5f43e6d9fdbccf49cc441959dc86fb30386a50807f22598a76fde8734972b3c61e68e654761dbc9969b16b7155564b3327dea3d6a003cf4c351aab48a7e4df6718115cd4f79c3272120d42b661051d30d9ef30525804bd50a71dccd230cf9fcc1425b38b29b450ca324486484e52801d8e2cd4bb30464c1f98b74f2a543c4c4b7b29f093d7d0124669a16fae6f1a9014083a17ab84c8de401edebab4777dacfd0720ab07e19b18e8aa7d91331a8dec5e6ef177eb881e200279db42894d8822262250fbcb770dc9c1016feb30538128d286b6329ff3c8437b81178fdde154333d347186445b19713b4032259191eea6ded44075387d7601452cf59326b9ddedb2d5943939a2ea",
			"f0b32257268466df8e2c6eb865711350659e03a6765b2d388ec40fa7a267ba6c55e65c8b78f3986a6cf8ba94db76c3e8527af6e0de62d5112253d001909e4757e035a1d78548c71dcd6d400a8cbd0b7aad3ae814bf043f2c874011e66d5ba2c512f2590104df08b9a9f29a004324499a91d97778b0a8824a556ab66d0964085387a213bcbb114de85c0a49dc07a51baafaf8ca411b725f0cd083dda703506cfa9c85124f79db7b751a9c157223b829347bf279faccf8ca484e5ac9113cce223fd6bab4c10501ad859002dce92a7c5118da795d37f177180078815bc4718851b2255be5a44bf5049211d5fd2e085a1b01d45df9c3d0d06a7d3618b359e91fab71",
			"a603000000000003000000c800000032000186a000000035000000c800000043000000c80000005000000005000000060000000000000007000000000000001d0000000000000009000000000000000a000000010000000c000000000000000d5823b34900000058000000000000004a000002a0ffffffff0000000f0000000100000000000001bb0000000e3134392e3135342e3137352e3530000000000000000100000001000001bb00000027323030313a306232383a663233643a663030313a303030303a303030303a303030303a30303061000000000000000200000000000001bb0000000e3134392e3135342e3136372e3530000000000000000200000010000001bb0000000e3134392e3135342e3136372e3531000000000000000200000001000001bb00000027323030313a303637633a303465383a663030323a303030303a303030303a303030303a30303061000000000000000300000000000001bb0000000f3134392e3135342e3137352e313030000000000000000300000001000001bb00000027323030313a306232383a663233643a663030333a303030303a303030303a303030303a30303061000000000000000400000000000001bb0000000e3134392e3135342e3136372e3932000000000000000400000010000001bb0000000e3134392e3135342e3136372e3931000000000000000400000001000001bb00000027323030313a303637633a303465383a663030343a303030303a303030303a303030303a30303061000000000000000400000002000001bb0000000f3134392e3135342e3136342e323530000000000000000400000003000001bb00000027323030313a303637633a303465383a663030343a303030303a303030303a303030303a30303062000000000000000500000001000001bb00000027323030313a306232383a663233663a663030353a303030303a303030303a303030303a30303061000000000000000500000010000001bb0000000d39312e3130382e35362e313330000000000000000500000000000001bb0000000d39312e3130382e35362e313731000000000000000000000019ffffffff000000530000001a0061007000760032002e007300740065006c002e0063006f006d00000057000000000000004f000000050000000000000001000000000000000000000028000000000000005400000000000000000000000000000000000000000000004e89f68d97393267c20000000e0000025a000003c20000025400000390c674053f00000000ea56f1191d328106fbd1",
		},
		{
			"c7fc72231690aede4a25397040d578fed75d288ad4aaf29131a8097bb44cc208",
			"37e0c050c3002441eab3e68da87ba7a96521b073affe69b249c44c79de1cfa285c03cf04e8f02fa8d00838eb48005621c9cb199516cdffab7b539554719af2fb6cb4c3ec6fec2239162ae60f4e4607c1821115393d19f076b7aa1157737842d4dd76ae9b2a93d9bf3e1b463cd063051964b548f7ec615632c8d77b0cef70d47be7c2ccb64e21d54fdfce886e84a93eb148dc992a3067dc3b30b2b39a8ceae88a2d6968ba3b921e41744f337d87b4e30fdc1208270588d35a8150d050915a5b7dc50db5f817165d7771a143eff8bab4b9a780bfee3bea8b5887ca1d767c62f8022ab67d5680ad2dacfa56b350e1604386fb166ec099672b6d8501602ef1aa795a502492e4219615878ff5f5f1b6a97dcdc3db11f83248579969d22cc3be536c91",
			"570a70d37ff15e18417f39ca03e80935a5bea6feaf3b2646d1138ace07d473b02d8919265f286eeda4978dd2648b658be7c4a8c235a520abeb8c062715fb7432543528e0b64f182ba6c1fc78a9d340eb52ac01bec26beebab7466f6d8a884f14de5fce04190375906cb197e9cc9109cffb95e7dd77b825c70cd7eb162ef837f67712ee488b464c2e751a0a0ccd85eeec5b8012cc680978497f3a8b79fe273491d05e06ffa563b84e74a7cda40449f271767f74861334a0e4fdcaf8d227c1244071a75a2d2035dab62eab5324e0e7ac30cfa9ae39c3a6b04db4c92aa3c56a2e3ae9d5a97c3bf600a92539b20a3d8c9e86927c160bf0d970f45235fa15aa263ae4",
			"040100003ef94368d02a3ab1607de3011c6ba33befc777c801b61dba8c887dca2cfa1b157aedc727888c554006b5630bacc2b1d0a87863b626c668c4f9d5bb43a3ab2f5682e7ec4dcb578f6dedd716d55055497b917a720f228ba233267b94d389f34b9ef4ccc505772c9d4128c876e238b9128ca652c5db3bc316a83bf750a2bde8af8309b890ded9a2add9e22b1c51e5bdbe353d7e9a9c6f4bc0b1808506fbbbaaba8e2d797c6ffdcf5b76e50a5ee1688975f51000961781dce37f262230f06f65cbb86a4d3a2290d83f693018965c4695edefad9182c453e9a56c25e15d2537a4b0e9acd3cd1c499022cb8a2417e8c9002e9960debca52c23bc7ce1dde80553efa0e02b9ce90e2d90ae35bd261c10",
		},
	}

	for _, tt := range cases {
		_salt, err := hex.DecodeString(tt.salt)
		if err != nil {
			t.Fatal(err)
		}
		_encrypted, err := hex.DecodeString(tt.encrypted)
		if err != nil {
			t.Fatal(err)
		}
		_key, err := hex.DecodeString(tt.key)
		if err != nil {
			t.Fatal(err)
		}
		_decrypted, err := hex.DecodeString(tt.decrypted)
		if err != nil {
			t.Fatal(err)
		}
		key := CreateLocalKey([]byte{}, _salt)
		if string(_key) != string(key) {
			t.Fatalf("wrong key. Expected %s, got %s", hex.EncodeToString(_key), hex.EncodeToString(key))
		}
		decrypted, err := DecryptLocal(_encrypted,
			key)
		if err != nil {
			t.Fatal(err)
		}
		if string(_decrypted) != string(decrypted) {
			t.Fatalf("wrong decrypted. Expected %s, got %s", hex.EncodeToString(_decrypted), hex.EncodeToString(decrypted))
		}
	}
}
